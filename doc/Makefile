HANDBOOKS=en
IN_BASENAME=exscript
OUT_BASENAME=exscript

all: handbook apidocs

pdf:
	# Generate a latex file that defines the version number.
	cd ..; VERSION=`python setup.py --version`; cd -; \
	echo '% This file is automatically generated; do not edit' > version.tex; \
	echo "\\\newcommand{\\\productversion}{$$VERSION }" >> version.tex
	
	# Generate a latex file that includes Exscript's command line options.
	echo '% This file is automatically generated; do not edit' > cliopt.tex
	echo "\\\begin{lstlisting}" >> cliopt.tex
	python ../exscript --help | tail -n+3 >> cliopt.tex
	echo "\\\end{lstlisting}" >> cliopt.tex
	
	# Generate a latex file that includes Exscript's stdlib commands.
	echo '% This file is automatically generated; do not edit' > stdlib.tex
	echo "\\\begin{enumerate}" >> stdlib.tex
	find ../src/Exscript/Interpreter/stdlib/ -name "*.py" -a ! -name "__init__.py" \
	 | sort \
	 | while read file; do \
	 	 FUNC=`echo $$file \
		       | cut -d/ -f6- \
					 | tr '[:upper:]' '[:lower:]' \
					 | sed 's/.py$$//; s/\//./g; s/_/\\\_/g'`; \
	   ARGS=`grep "^def execute" $$file \
		       | sed 's/^def execute//; s/:$$//; s/_/\\\_/g; s/scope,* *//'`; \
		 [ "$$ARGS" != "" ] && echo "\\\item $$FUNC$$ARGS"; \
	 done >> stdlib.tex
	echo "\\\end{enumerate}" >> stdlib.tex

	# Generate GraphViz figures. Unfortunately, pdflatex does not work when 
	# including these figures in PDF, tex, or PS format, so we are stuck with 
	# png.
	#for FILE in figures/*.dot; do \
	#	DESTFILE=`echo $$FILE | sed 's/.dot\$$//'`.png; \
	#	dot -Tpng -Gmargin=0 $$FILE -o $$DESTFILE; \
	#done

	# Run each call of pdflatex twice, required to resolve references.
	for LOCALE in $(HANDBOOKS); do \
		FILE=$(IN_BASENAME).$$LOCALE; \
		pdflatex -halt-on-error $$FILE.tex && pdflatex $$FILE.tex; \
		rm $$FILE.aux $$FILE.log $$FILE.out $$FILE.toc; \
		[ ! -e handbook/$$LOCALE ] && mkdir -p handbook/$$LOCALE/; \
		mv $$FILE.pdf handbook/$$LOCALE/$(OUT_BASENAME).$$LOCALE.pdf; \
	done

handbook: pdf
	for LOCALE in $(HANDBOOKS); do \
		FILE=$(IN_BASENAME).$$LOCALE; \
		latex2html -nonavigation -toc_depth 5 -split 0 -html_version 4.0,unicode -mkdir -dir handbook/$$LOCALE/ $$FILE.tex; \
	done

apidocs:
	python mkapidoc.py

clean:
	rm -Rf api handbook
	rm -f *.aux *.log *.out *.pdf *.toc # figures/*.png

publish: handbook apidocs
	scp -r handbook/* api/* kd10243@goliath.speedpartner.de:/home/kd10243/exscript.debain.org/static/docs/exscript/
